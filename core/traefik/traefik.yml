services:
  # Fix file permissions at startup
  init-acme:
    image: busybox:1.36
    container_name: init-acme
    command: sh -c "touch /data/acme.json && chown ${PUID}:${SOCKET_GID} /data/acme.json && chmod 600 /data/acme.json && chown ${PUID}:${SOCKET_GID} /traefik_dynamic.yml"
    volumes:
      - ./data:/data
      - ./traefik_dynamic.yml:/traefik_dynamic.yml
    network_mode: none
    read_only: true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - FOWNER
      - DAC_OVERRIDE
    security_opt:
      - no-new-privileges:true

  # Security Proxy for Docker Socket
  socket-proxy:
    image: tecnativa/docker-socket-proxy
    container_name: socket-proxy
    restart: unless-stopped
    read_only: true

    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

    tmpfs:
      - /run
      - /tmp

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

    environment:
      CONTAINERS: 1 # Allow listing containers

    networks:
      - socket-internal

  traefik:
    image: traefik:v3
    container_name: traefik
    user: "${PUID}:${SOCKET_GID}"
    depends_on:
      init-acme:
        condition: service_completed_successfully
    restart: unless-stopped
    
    env_file:
      - ../../.env
      - .env

    # Pass the DNS Provider API Key securely from your .env file
    environment:
      # If using Gandi.net (v5 API):
      - GANDIV5_PERSONAL_ACCESS_TOKEN=${ACME_API_TOKEN}
      # Notice: LEGO_DISABLE_CNAME_SUPPORT is removed so CNAME delegation works!

    cap_drop: [ALL]
    cap_add: [NET_BIND_SERVICE]
    security_opt: [no-new-privileges:true]
    read_only: true
    tmpfs: [/tmp]

    ports:
      - "80:80"
      - "443:443"

    command:
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--api.dashboard=true"

      # Docker Provider (via Proxy)
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.endpoint=tcp://socket-proxy:2375"

      # File Provider
      - "--providers.file.filename=/traefik_dynamic.yml"
      - "--providers.file.watch=true"

      # Entrypoints (HTTP automatically redirects to HTTPS)
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"

      # --- Let's Encrypt Staging (DNS Challenge) ---
      # Remember to remove "-staging" from the caServer URL when moving to production!
      - "--entrypoints.websecure.http.tls.certresolver=myresolver"
      - "--certificatesresolvers.myresolver.acme.caServer=https://acme-staging-v02.api.letsencrypt.org/directory"
      - "--certificatesresolvers.myresolver.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.myresolver.acme.storage=/data/acme.json"
      - "--certificatesresolvers.myresolver.acme.dnschallenge=true"
      - "--certificatesresolvers.myresolver.acme.dnschallenge.provider=gandiv5"
      - "--certificatesresolvers.myresolver.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53"
      # Give Gandi DNS time to sync the TXT record before Let's Encrypt checks it
      - "--certificatesresolvers.myresolver.acme.dnschallenge.delayBeforeCheck=10" 

    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"
      
      # Dashboard Router
      - "traefik.http.routers.dashboard.rule=${DASHBOARD_HOST_RULE}"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=sec-public@file"
      - "traefik.http.middlewares.dashboard-auth.basicauth.users=${DASHBOARD_CREDENTIALS}"

    volumes:
      - ./data:/data
      - ./traefik_dynamic.yml:/traefik_dynamic.yml:ro

    networks:
      - traefik-public
      - socket-internal
    
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  traefik-public:
    name: traefik-public
  socket-internal:
    name: socket-internal