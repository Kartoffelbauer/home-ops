services:
  # Fix file permissions at startup
  init-acme:
    image: busybox:1.36
    container_name: init-acme
    command: sh -c "chown ${PUID}:${SOCKET_GID} /acme.json /traefik_dynamic.yml && chmod 600 /acme.json /traefik_dynamic.yml"
    volumes:
      - ./acme.json:/acme.json
      - ./traefik_dynamic.yml:/traefik_dynamic.yml
    network_mode: none
    read_only: true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - FOWNER
    security_opt:
      - no-new-privileges:true

  # Security Proxy for Docker Socket
  socket-proxy:
    image: tecnativa/docker-socket-proxy
    container_name: socket-proxy
    restart: unless-stopped
    read_only: true

    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

    tmpfs:
      - /run
      - /tmp

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

    environment:
      CONTAINERS: 1 # Allow listing containers

    networks:
      - socket-internal

  traefik:
    image: traefik:v3
    container_name: traefik
    user: "${PUID}:${SOCKET_GID}"
    depends_on:
      init-acme:
        condition: service_completed_successfully
    restart: unless-stopped
    
    env_file:
      - ../../.env
      - .env

    cap_drop: [ALL]
    cap_add: [NET_BIND_SERVICE]
    security_opt: [no-new-privileges:true]
    read_only: true
    tmpfs: [/tmp]

    ports:
      - "80:80"
      - "443:443"

    command:
      # Logs
      - "--log.level=INFO"
      - "--accesslog=true" # Important for debugging 404s/500s
      
      # Dashboard
      - "--api.dashboard=true"

      # Docker Provider (via Proxy)
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.endpoint=tcp://socket-proxy:2375" # Secure connection

      # File Provider
      - "--providers.file.filename=/traefik_dynamic.yml"
      - "--providers.file.watch=true"

      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"

      # Let's Encrypt
      #- "--entrypoints.websecure.http.tls.certresolver=myresolver"
      #- "--certificatesresolvers.myresolver.acme.tlschallenge=true"
      #- "--certificatesresolvers.myresolver.acme.email=${ACME_EMAIL}"
      #- "--certificatesresolvers.myresolver.acme.storage=/acme.json"

      # --- Let's Encrypt Staging ---
      - "--entrypoints.websecure.http.tls.certresolver=myresolver"
      - "--certificatesresolvers.myresolver.acme.caServer=https://acme-staging-v02.api.letsencrypt.org/directory"
      - "--certificatesresolvers.myresolver.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.myresolver.acme.storage=/acme.json"
      - "--certificatesresolvers.myresolver.acme.httpchallenge=true"
      - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=${DASHBOARD_HOST_RULE}"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=sec-admin@file,dashboard-auth@docker"
      - "traefik.http.middlewares.dashboard-auth.basicauth.users=${DASHBOARD_CREDENTIALS}"

    volumes:
      - ./acme.json:/acme.json
      - ./traefik_dynamic.yml:/traefik_dynamic.yml:ro

    networks:
      - traefik-public
      - socket-internal
    
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  traefik-public:
    name: traefik-public
  socket-internal:
    name: socket-internal